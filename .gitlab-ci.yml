image: runmymind/docker-android-sdk:ubuntu-standalone-20251027

variables:
  USE_PROXY_REPO: true

before_script:
  - export GRADLE_USER_HOME=`pwd`/.gradle

cache: &global_cache
  when: always
  paths:
    - .gradle/wrapper
    - .gradle/caches
    - .gradle/jdks

stages:
  - test

components-tests:
  stage: test
  cache:
    <<: *global_cache
    key: components-tests
  script: ./gradlew :components:jvmTest
  artifacts:
    when: always
    reports:
      junit: components/build/test-results/jvmTest/**/TEST-*.xml

android-tests:
  stage: test
  cache:
    <<: *global_cache
    key: android-tests
  script: ./gradlew :composeApp:testDebugUnitTest
  artifacts:
    when: always
    paths:
      - composeApp/build/outputs/roborazzi/*_compare.png
    reports:
      junit: composeApp/build/test-results/testDebugUnitTest/**/TEST-*.xml

jvm-tests:
  stage: test
  cache:
    <<: *global_cache
    key: jvm-tests
  script: ./gradlew :composeApp:jvmTest
  artifacts:
    when: always
    reports:
      junit: composeApp/build/test-results/jvmTest/**/TEST-*.xml

update-screenshots:
  stage: test
  cache:
    <<: *global_cache
    key: update-screenshots
  when: manual
  allow_failure: true
  script: ./gradlew :composeApp:recordRoborazziDebug
  after_script:
    - git config user.email "${GITLAB_USER_EMAIL}"
    - git config user.name "GitLab CI Bot"
    - git add .
    - git commit -m "[gitlab-ci] Update screenshots"
    - git push "https://oauth2:${REPO_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" HEAD:"${CI_COMMIT_REF_NAME}"
